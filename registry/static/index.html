<html><head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Experiment Registry</title>
	</head>
	<body>
	<script>
	function httpGet(url, callback)
	{
		var xhr = new XMLHttpRequest();
		xhr.open("GET", url, true);
		xhr.onload = function (e) {
			callback(xhr.responseText);
		};
		xhr.send(null);
	}

	function catchSubmit(form, callback) {
		if (form.attachEvent) {
			form.attachEvent("submit", callback);
		} else {
			form.addEventListener("submit", callback);
		}
	}

	function getStatus() {
		httpGet('/status', function(text) {
      let response = JSON.parse(text)
      let now = Date.now()
      let ret = "<table border='1'><tr><th>Name</th><th>Address</th><th>Status</th><th>Operations</th></tr>\n"
      for (const lease of response.leases) {
        let expiry = new Date(lease.when)
        // .format("yyyy-mm-dd HH:MM:ss l")
        let status = lease.status
        if (status == 'ACTIVE' && lease.when < now) {
          status = 'EXPIRED'
        }

        ret += `<tr><td>${lease.role}</td><td>${lease.address}</td><td>${status}</td>\n`
        ret += `<td>
        <a href='#' onclick='deregister("${lease.role}", "output-${lease.role}")'>deregister</a>
        <a href='#' onclick='remove("${lease.role}", "output-${lease.role}")'>remove</a>
        <span id="output-${lease.role}"></span>
        </td></tr>\n`
      }
      ret += `</table><i>Lease duration: ${response.duration} milliseconds</i>`
      document.getElementById("status").innerHTML = ret
		})
	}

	function deregister(role, output) {
		event.preventDefault()
		fetch(`/deregister?role=${role}`, {mode: 'cors'}).then((r)=>{r.text().then((s) => {
			let dest = document.getElementById(output)
			dest.innerHTML = s
			setTimeout(() => {
				dest.innerHTML = ''
				getStatus();
			}, 1000)
		})})
	}

	function remove(role, output) {
		event.preventDefault()
		fetch(`/remove?role=${role}`, {mode: 'cors'}).then((r)=>{r.text().then((s) => {
			let dest = document.getElementById(output)
			dest.innerHTML = s
			setTimeout(() => {
				dest.innerHTML = ''
				getStatus();
			}, 1000)
		})})
	}

	window.onload = function() {
		getStatus();

		var register = document.getElementById('register');
		catchSubmit(register, function(event) {
			event.preventDefault();
			var role = register.elements['role'].value
			var address = register.elements['address'].value
			if (role.trim() && address.trim()) {
				httpGet('/register?role='+role+'&address='+address, function(text) {
					document.getElementById("regout").innerHTML = text
					getStatus();
				})
			} else {
				document.getElementById("regout").innerHTML = "Please supply valid role and address"
			}
			return false
		})

		var lookup = document.getElementById('lookup');
		catchSubmit(lookup, function(event) {
			event.preventDefault();
			var role = lookup.elements['role'].value
			if (role.trim()) {
				httpGet('/lookup?role='+role, function(text) {
					document.getElementById("lookout").innerHTML = text
				})
			} else {
				document.getElementById("lookout").innerHTML = "Please supply valid role"
			}
			return false
		})

		var lease = document.getElementById('lease');
		catchSubmit(lease, function(event) {
			event.preventDefault();
			var duration = lease.elements['duration'].value
			if (duration.trim()) {
			alert(' set lease ' + duration )
				httpGet('/status?duration='+duration, function(text) {
					document.getElementById("status").innerHTML = text
				})
			} else {
				document.getElementById("leaseout").innerHTML = "Please supply valid duration"
			}
			return false
		})

		document.getElementById('clear').addEventListener('click', event => {
			event.preventDefault()
			fetch('/clear', {mode: 'cors'}).then((r)=>{r.text().then((s) => {
				document.getElementById('clear-output').innerHTML = s
				setTimeout(() => {
					document.getElementById('clear-output').innerHTML = ''
				}, 1000)
				getStatus();
			})})
		})

		document.getElementById('shutdown').addEventListener('click', event => {
			event.preventDefault()
			fetch('/shutdown', {mode: 'cors'}).then((r)=>{r.text().then((s) => {
				document.getElementById('shutdown-output').innerHTML = s
				setTimeout(() => {
					document.getElementById('shutdown-output').innerHTML = ''
				}, 1000)
				getStatus();
			})})
		})
	}
	</script>

	<div id=mode></div>
	<H1>Experiment Registry</h1>
	<div id='status'>
	</div>
	<h1>Register</h1>
	<form id='register'>
		<label for='role'>Role:</label>
		<input type='text' id='role' name='role'/>
		<label for='address'>Address:</label>
		<input type='text' id='address' name='address'/>
		<button type="submit">Submit</button>
	</form>
	<div id=regout></div>

	<h1>Lookup</h1>
	<form id='lookup'>
		<label for='role'>Role:</label>
		<input type='text' id='role' name='role'/>
		<button type="submit">Submit</button>
	</form>
	<div id=lookout></div>

	<h1>Set Default Lease</h1>
	<form id='lease'>
		<label for='duration'>Duration:</label>
		<input type='text' id='duration' name='duration'/>
		<button type="submit">Submit</button>
	</form>
	<div id=leaseout></div>

	<h1>General Operations</h1>
	<ul>
		<li><a href='#' id='clear'>Clear Lease Table</a> <span id='clear-output'></span></li>
		<li><a href='#' style='color:red'id='shutdown'>Shut Down Registry</a> <span id='shutdown-output'></span></li>
	</ul>

	</body>
</html>